<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ES SQL Query Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#0FC6C2',
                        success: '#00B42A',
                        warning: '#FF7D00',
                        danger: '#F53F3F',
                        dark: '#1D2129',
                        light: '#F2F3F5'
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                },
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }

            .bg-gradient-primary {
                background: linear-gradient(135deg, #165DFF 0%, #0A44C0 100%);
            }

            .text-shadow {
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            .transition-all-300 {
                transition: all 300ms ease-in-out;
            }

            .card-hover {
                @apply hover:shadow-lg hover:-translate-y-1 transition-all duration-300;
            }

            .table-cell-border {
                @apply border-r border-gray-200;
            }

            .table-header-cell {
                @apply bg-primary/10 text-primary font-semibold py-4;
            }

            .pagination-active {
                @apply bg-primary text-white;
            }

            .animate-fade-in {
                animation: fadeIn 0.3s ease-out forwards;
            }

            .sortable-header {
                @apply cursor-pointer hover:bg-primary/20 transition-colors duration-150;
            }

            /* 添加表格对齐样式 */
            .table-cell-align-left {
                @apply text-left;
            }

            .table-cell-align-right {
                @apply text-right;
            }

            .table-cell-align-center {
                @apply text-center;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 添加自定义表格样式 */
        .result-table {
            @apply min-w-full divide-y divide-gray-200;
        }

        .result-table thead th {
            @apply px-6 py-4 text-left text-xs font-medium text-primary tracking-wider table-header-cell table-cell-border sortable-header;
        }

        .result-table tbody td {
            @apply px-6 py-4 whitespace-nowrap text-sm text-gray-500 border-b border-gray-200;
        }

        .result-table tbody tr:hover {
            @apply bg-gray-50;
        }

        /* 数字列对齐样式 */
        .number-cell {
            @apply text-left font-mono;
        }
    </style>
</head>

<body class="font-inter bg-gray-50 text-dark min-h-screen flex flex-col">
<div id="toastContainer" class="fixed top-4 right-4 z-[9999]"></div>
<!-- 导航栏 -->
<nav class="bg-white shadow-md sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
        <div class="flex items-center space-x-2">
            <i class="fa fa-search text-primary text-2xl"></i>
            <h1 class="text-xl font-bold text-primary"><span data-lang="app-title">ES SQL Query Tool</span></h1>
        </div>
        <div class="flex items-center space-x-4">
            <div class="relative">
                <select id="langToggle"
                        class="appearance-none bg-gray-100 border border-gray-200 rounded-lg py-2 pl-3 pr-8 focus:outline-none focus:ring-2 focus:ring-primary/50">
                    <option value="en">English</option>
                    <option value="zh">中文</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-dark">
                    <i class="fa fa-chevron-down text-xs"></i>
                </div>
            </div>
        </div>
    </div>
</nav>

<!-- 主内容区 -->
<main class="flex-grow container mx-auto px-4 py-8">
    <!-- 查询区域 -->
    <div class="bg-white rounded-xl shadow-md p-6 mb-8 transform transition-all duration-200 hover:shadow-lg">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold text-dark flex items-center">
                <i class="fa fa-code text-primary mr-2"></i>
                <span data-lang="query-area">Query Area</span>
            </h2>
            <div class="flex space-x-2">
                <button id="clearBtn"
                        class="px-3 py-1.5 bg-gray-100 hover:bg-gray-300 text-dark rounded-lg transition-all-300 flex items-center">
                    <i class="fa fa-trash-o mr-1"></i>
                    <span data-lang="clear">Clear</span>
                </button>
            </div>
        </div>

        <div class="mb-4">
            <div class="relative">
          <textarea id="sqlQuery"
                    class="w-full h-32 p-4 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 font-mono"
                    placeholder="Enter SQL query...">select * from my_index</textarea>
                <div class="absolute right-3 bottom-3 text-xs text-gray-400">
                    <span id="charCount">20</span> <span data-lang="characters">characters</span>
                </div>
            </div>
        </div>

        <div class="flex justify-end">
            <button id="executeBtn"
                    class="bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-lg shadow-md hover:shadow-lg transition-all-300 flex items-center">
                <i class="fa fa-play mr-2"></i>
                <span data-lang="execute">Execute Query</span>
            </button>
        </div>
    </div>

    <!-- 结果区域 -->
    <div id="resultContainer"
         class="bg-white rounded-xl shadow-md p-6 mb-8 hidden transform transition-all duration-300 hover:shadow-lg">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold text-dark flex items-center">
                <i class="fa fa-table text-primary mr-2"></i>
                <span data-lang="result">Query Result</span>
                <span id="resultCount" class="ml-2 text-sm text-gray-500">(0 <span
                        data-lang="records">records</span>)</span>
            </h2>
            <div class="flex space-x-2">
                <button id="copyBtn"
                        class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-dark rounded-lg transition-all-300 flex items-center">
                    <i class="fa fa-copy mr-1"></i>
                    <span data-lang="copy">Copy</span>
                </button>
                <div class="relative">
                    <button id="downloadBtn"
                            class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-dark rounded-lg transition-all-300 flex items-center">
                        <i class="fa fa-download mr-1"></i>
                        <span data-lang="download">Download</span>
                    </button>
                    <div id="downloadMenu"
                         class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 hidden z-10">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-format="csv">CSV</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-format="json">JSON</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-format="excel">Excel</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- 搜索框 -->
        <div class="mb-4">
            <div class="relative">
                <input type="text" id="searchInput" placeholder="Search..."
                       class="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 pl-10">
                <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                    <i class="fa fa-search"></i>
                </div>
            </div>
        </div>

        <!-- 结果分布统计 -->
        <div id="resultStats" class="mb-4 bg-gray-50 p-4 rounded-lg hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center mr-3">
                        <i class="fa fa-database text-primary"></i>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500" data-lang="total-records">Total Records</p>
                        <p class="text-lg font-semibold" id="totalRecords">0</p>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-secondary/10 flex items-center justify-center mr-3">
                        <i class="fa fa-columns text-secondary"></i>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500" data-lang="total-columns">Total Columns</p>
                        <p class="text-lg font-semibold" id="totalColumns">0</p>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-success/10 flex items-center justify-center mr-3">
                        <i class="fa fa-filter text-success"></i>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500" data-lang="filtered-records">Filtered Records</p>
                        <p class="text-lg font-semibold" id="filteredRecords">0</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table id="resultTable" class="result-table">
                <thead>
                <tr id="tableHeader"></tr>
                </thead>
                <tbody id="tableBody" class="bg-white divide-y divide-gray-200"></tbody>
            </table>
        </div>

        <!-- 分页控件 -->
        <div id="paginationControls" class="mt-6 flex flex-col md:flex-row justify-between items-center hidden">
            <div class="mb-4 md:mb-0">
                <label for="pageSize" class="text-sm text-gray-500 mr-2" data-lang="show">Show</label>
                <select id="pageSize"
                        class="bg-gray-50 border border-gray-200 rounded-lg py-1 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
                <span class="text-sm text-gray-500 ml-2" data-lang="entries">entries</span>
            </div>

            <div class="flex items-center space-x-1">
                <button id="firstPage"
                        class="px-3 py-1.5 rounded-lg border border-gray-200 text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fa fa-angle-double-left"></i>
                </button>
                <button id="prevPage"
                        class="px-3 py-1.5 rounded-lg border border-gray-200 text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fa fa-angle-left"></i>
                </button>
                <div id="pageNumbers" class="flex"></div>
                <button id="nextPage"
                        class="px-3 py-1.5 rounded-lg border border-gray-200 text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fa fa-angle-right"></i>
                </button>
                <button id="lastPage"
                        class="px-3 py-1.5 rounded-lg border border-gray-200 text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fa fa-angle-double-right"></i>
                </button>
            </div>
        </div>

        <div id="emptyResult" class="py-12 flex flex-col items-center justify-center hidden">
            <div class="w-16 h-16 mb-4 text-gray-300">
                <i class="fa fa-search fa-4x"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-1" data-lang="no-results">No results found</h3>
            <p class="text-gray-500 max-w-md text-center" data-lang="no-results-desc">Try modifying your query or check
                the
                syntax</p>
            <button id="clearSearchBtn"
                    class="mt-4 px-4 py-2 bg-primary/10 text-primary rounded-lg hover:bg-primary/20 transition-colors duration-150">
                <i class="fa fa-times-circle mr-1"></i>
                <span data-lang="clear-search">Clear Search</span>
            </button>
        </div>
    </div>

    <!-- 加载中 -->
    <div id="loadingIndicator" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-lg flex items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary mr-4"></div>
            <div>
                <h3 class="font-semibold text-dark" data-lang="loading">Executing query...</h3>
                <p class="text-gray-500 text-sm" data-lang="please-wait">Please wait...</p>
            </div>
        </div>
    </div>

    <!-- 错误提示 -->
    <div id="errorContainer"
         class="bg-white rounded-xl shadow-md p-6 mb-8 hidden transform transition-all duration-300 hover:shadow-lg">
        <div class="flex items-start">
            <div class="flex-shrink-0 pt-0.5">
                <i class="fa fa-exclamation-triangle text-danger text-xl"></i>
            </div>
            <div class="ml-3 flex-1">
                <h3 class="text-lg font-medium text-danger" data-lang="error-occurred">An error occurred while executing
                    the
                    query</h3>
                <div class="mt-2 text-sm text-gray-700">
                    <p id="errorMessage">Error message will be displayed here</p>
                </div>
                <div class="mt-4">
                    <pre id="errorDetails" class="bg-gray-50 p-3 rounded-lg text-xs font-mono overflow-x-auto"></pre>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- 页脚 -->
<footer class="bg-dark text-white py-6">
    <div class="container mx-auto px-4">
        <div class="flex flex-col md:flex-row justify-between items-center">
            <div class="mb-4 md:mb-0">
                <div class="flex items-center space-x-2">
                    <i class="fa fa-search text-primary"></i>
                    <span class="font-semibold" data-lang="app-title">ES SQL Query Tool</span>
                </div>
            </div>
            <div class="flex space-x-4">
                <a href="https://github.com/junqiangChi/es-sql"
                   class="text-gray-400 hover:text-white transition-colors duration-300">
                    <i class="fa fa-github text-xl"></i>
                </a>
            </div>
        </div>
    </div>
</footer>

<script>
    // 语言包
    const translations = {
        'en': {
            'app-title': 'ES SQL Query Tool',
            'app-desc': 'Efficiently query Elasticsearch data',
            'query-area': 'Query Area',
            'clear': 'Clear',
            'characters': 'characters',
            'execute': 'Execute Query',
            'result': 'Query Result',
            'records': 'records',
            'copy': 'Copy',
            'download': 'Download',
            'no-results': 'No results found',
            'no-results-desc': 'Try modifying your query or check the syntax',
            'loading': 'Executing query...',
            'please-wait': 'Please wait...',
            'error-occurred': 'An error occurred while executing the query',
            'all-rights': 'All rights reserved',
            'toast-copied': 'Content copied to clipboard',
            'toast-copy-failed': 'Failed to copy, please copy manually',
            'toast-execute-success': 'Query executed successfully',
            'toast-execute-failed': 'Query execution failed',
            'toast-enter-query': 'Please enter an SQL query',
            'toast-api-error': 'API call failed',
            'toast-api-error-details': 'Please check the error details',
            'json-format-error': 'There are no headers or rows in the returned JSO results',
            'search-placeholder': 'Search in results...',
            'total-records': 'Total Records',
            'total-columns': 'Total Columns',
            'filtered-records': 'Filtered Records',
            'show': 'Show',
            'reason': 'Reason',
            'entries': 'entries',
            'page': 'Page',
            'of': 'of',
            'clear-search': 'Clear Search',
            'csv-format': 'CSV Format',
            'json-format': 'JSON Format',
            'excel-format': 'Excel Format',
            'downloading': 'Downloading',
            'es-query-result': 'EsQueryResult'
        },
        'zh': {
            'app-title': 'ES SQL 查询工具',
            'app-desc': '高效查询 Elasticsearch 数据',
            'query-area': '查询区域',
            'clear': '清空',
            'characters': '字符',
            'execute': '执行查询',
            'result': '查询结果',
            'records': '记录',
            'copy': '复制',
            'download': '下载',
            'no-results': '没有找到结果',
            'no-results-desc': '尝试修改查询条件或检查语法是否正确',
            'loading': '正在执行查询...',
            'please-wait': '请稍候...',
            'error-occurred': '执行查询时出错',
            'all-rights': '保留所有权利',
            'toast-copied': '内容已复制到剪贴板',
            'toast-copy-failed': '复制失败，请手动复制',
            'toast-execute-success': '查询执行成功',
            'toast-execute-failed': '查询执行失败',
            'toast-api-error': '接口调用失败',
            'toast-api-error-details': '请查看错误详情',
            'json-format-error': '返回JSO结果中没有headers或者rows',
            'toast-enter-query': '请输入 SQL 查询',
            'search-placeholder': '在结果中搜索...',
            'total-records': '总记录数',
            'total-columns': '总列数',
            'filtered-records': '过滤后记录',
            'show': '显示',
            'reason': '原因',
            'entries': '条记录',
            'page': '第',
            'of': '页，共',
            'clear-search': '清空搜索',
            'csv-format': 'CSV 格式',
            'json-format': 'JSON 格式',
            'excel-format': 'Excel 格式',
            'downloading': '正在下载',
            'es-query-result': 'Es查询结果'
        }
    };

    const esHost = window.location.hostname || 'localhost';
    const esPort = window.location.port || '9200';

    // 分页相关变量
    let currentPage = 1;
    let pageSize = 10;
    let filteredData = [];
    let originalData = [];
    let sortField = null;
    let sortDirection = 'asc';

    // 当前语言
    let currentLang = 'en';

    // 更新界面语言
    function updateLanguage(lang) {
        currentLang = lang;
        document.querySelectorAll('[data-lang]').forEach(el => {
            const key = el.getAttribute('data-lang');
            if (translations[lang][key]) {
                el.textContent = translations[lang][key];
            }
        });

        // 更新搜索框占位符
        document.getElementById('searchInput').placeholder = translations[lang]['search-placeholder'];

        // 更新下载菜单
        document.querySelectorAll('#downloadMenu a').forEach(link => {
            const format = link.getAttribute('data-format');
            if (format === 'csv') {
                link.textContent = translations[lang]['csv-format'];
            } else if (format === 'json') {
                link.textContent = translations[lang]['json-format'];
            } else if (format === 'excel') {
                link.textContent = translations[lang]['excel-format'];
            }
        });

        // 更新语言选择器
        document.getElementById('langToggle').value = lang;
    }

    // 字符计数
    const sqlQuery = document.getElementById('sqlQuery');
    const charCount = document.getElementById('charCount');

    sqlQuery.addEventListener('input', function () {
        charCount.textContent = this.value.length;
    });

    // 执行查询
    document.getElementById('executeBtn').addEventListener('click', executeQuery);

    // 清空按钮
    document.getElementById('clearBtn').addEventListener('click', function () {
        sqlQuery.value = '';
        charCount.textContent = '0';
    });

    // 语言切换
    document.getElementById('langToggle').addEventListener('change', function () {
        updateLanguage(this.value);
    });

    // 复制结果
    document.getElementById('copyBtn').addEventListener('click', function () {
        const resultTable = document.getElementById('resultTable');
        if (resultTable.innerHTML.trim()) {
            const textToCopy = getTableText(resultTable);
            navigator.clipboard.writeText(textToCopy).then(function () {
                showToast(translations[currentLang]['toast-copied']);
            }).catch(function (err) {
                showToast(translations[currentLang]['toast-copy-failed'], 'error');
            });
        }
    });

    // 下载结果
    document.getElementById('downloadBtn').addEventListener('click', function (e) {
        e.stopPropagation();
        document.getElementById('downloadMenu').classList.toggle('hidden');
    });

    // 下载格式选择
    document.querySelectorAll('#downloadMenu a').forEach(link => {
        link.addEventListener('click', function (e) {
            e.preventDefault();
            const format = this.getAttribute('data-format');
            downloadResults(format);
            document.getElementById('downloadMenu').classList.add('hidden');
        });
    });

    // 点击其他区域关闭下载菜单
    document.addEventListener('click', function (e) {
        if (!document.getElementById('downloadBtn').contains(e.target)) {
            document.getElementById('downloadMenu').classList.add('hidden');
        }
    });

    // 搜索功能
    document.getElementById('searchInput').addEventListener('input', function () {
        const searchTerm = this.value.toLowerCase().trim();
        if (!originalData || originalData.length === 0) return;

        if (searchTerm === '') {
            filteredData = [...originalData];
        } else {
            filteredData = originalData.filter(row => {
                return row.some(cell =>
                    cell.toString().toLowerCase().includes(searchTerm)
                );
            });
        }

        currentPage = 1;
        renderTable();
        updatePagination();
        updateResultStats();
    });

    // 清空搜索
    document.getElementById('clearSearchBtn').addEventListener('click', function () {
        document.getElementById('searchInput').value = '';
        filteredData = [...originalData];
        currentPage = 1;
        renderTable();
        updatePagination();
        updateResultStats();
    });

    // 分页相关事件
    document.getElementById('pageSize').addEventListener('change', function () {
        pageSize = parseInt(this.value);
        currentPage = 1;
        renderTable();
        updatePagination();
    });

    document.getElementById('firstPage').addEventListener('click', function () {
        if (currentPage > 1) {
            currentPage = 1;
            renderTable();
            updatePagination();
        }
    });

    document.getElementById('prevPage').addEventListener('click', function () {
        if (currentPage > 1) {
            currentPage--;
            renderTable();
            updatePagination();
        }
    });

    document.getElementById('nextPage').addEventListener('click', function () {
        if (currentPage < getTotalPages()) {
            currentPage++;
            renderTable();
            updatePagination();
        }
    });

    document.getElementById('lastPage').addEventListener('click', function () {
        const totalPages = getTotalPages();
        if (currentPage < totalPages) {
            currentPage = totalPages;
            renderTable();
            updatePagination();
        }
    });

    async function callApi(sql) {
        try {
            try {
                const apiUrl = `http://${esHost}:${esPort}/web_sql_query`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({"sql": sql})
                });
                const data = await response.json()
                if (!response.ok) {
                    console.error(data)
                    showToast(
                        `${translations[currentLang]['toast-api-error']} - ${data.error.reason}`,
                        'error',
                        data
                    );
                    throw new Error(`${translations[currentLang]['toast-execute-failed']}, ${translations[currentLang]['reason']}: ${data.error.reason}`);
                }
                return data;
            } catch (error) {
                throw error;
            }
        } catch (error) {
            throw error;
        }
    }

    // 执行查询函数
    function executeQuery() {
        const sql = sqlQuery.value.trim();
        if (!sql) {
            showToast(translations[currentLang]['toast-enter-query'], 'warning');
            return;
        }

        // 显示加载状态
        document.getElementById('loadingIndicator').classList.remove('hidden');
        document.getElementById('resultContainer').classList.add('hidden');
        document.getElementById('errorContainer').classList.add('hidden');

        callApi(sql)
            .then(data => {
                document.getElementById('loadingIndicator').classList.add('hidden');
                processResult(data);
            })
            .catch(error => {
                document.getElementById('loadingIndicator').classList.add('hidden');
                // 显示详细错误信息
                document.getElementById('errorContainer').classList.remove('hidden');
                document.getElementById('errorMessage').textContent = error.message;
                document.getElementById('errorDetails').textContent = error.stack || error.message;
            });
    }

    function showToast(message, type = 'success', details = '') {
        // 创建提示框元素
        const toast = document.createElement('div');

        // 设置样式和类
        let bgColor, textColor, icon;
        switch (type) {
            case 'error':
                bgColor = 'bg-danger';
                textColor = 'text-white';
                icon = 'fa-exclamation-circle';
                break;
            case 'warning':
                bgColor = 'bg-warning';
                textColor = 'text-white';
                icon = 'fa-exclamation-triangle';
                break;
            case 'success':
            default:
                bgColor = 'bg-success';
                textColor = 'text-white';
                icon = 'fa-check-circle';
                break;
        }

        toast.className = `mb-2 ${bgColor} ${textColor} px-6 py-3 rounded-lg shadow-lg z-50 flex items-center transform transition-all duration-300 translate-y-20 opacity-0 max-w-md`;

        // 设置内容
        toast.innerHTML = `
        <i class="fa ${icon} mr-2 text-xl"></i>
        <div class="flex-1">
          <div class="font-medium">${message}</div>
          ${details ? `<div class="text-xs mt-1 opacity-80">${details}</div>` : ''}
        </div>
        <button class="ml-4 close-toast">
          <i class="fa fa-times"></i>
        </button>
      `;

        // 添加到容器
        const container = document.getElementById('toastContainer');
        container.appendChild(toast);

        // 显示动画
        setTimeout(() => {
            toast.classList.remove('translate-y-20', 'opacity-0');
            toast.classList.add('translate-y-0', 'opacity-100');
        }, 10);

        // 添加关闭按钮事件
        toast.querySelector('.close-toast').addEventListener('click', () => {
            removeToast(toast);
        });

        // 自动关闭
        const autoCloseTimer = setTimeout(() => {
            removeToast(toast);
        }, 5000);

        // 鼠标悬停时暂停自动关闭
        toast.addEventListener('mouseenter', () => {
            clearTimeout(autoCloseTimer);
        });

        // 鼠标离开时重新设置自动关闭
        toast.addEventListener('mouseleave', () => {
            setTimeout(() => {
                removeToast(toast);
            }, 2000);
        });
    }

    function removeToast(toast) {
        toast.classList.add('translate-y-20', 'opacity-0');
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }

    // 处理查询结果
    function processResult(data) {
        const resultContainer = document.getElementById('resultContainer');
        const resultTable = document.getElementById('resultTable');
        const tableHeader = document.getElementById('tableHeader');
        const tableBody = document.getElementById('tableBody');
        const resultCount = document.getElementById('resultCount');
        const emptyResult = document.getElementById('emptyResult');
        const paginationControls = document.getElementById('paginationControls');
        const resultStats = document.getElementById('resultStats');

        // 清空表格
        tableHeader.innerHTML = '';
        tableBody.innerHTML = '';

        // 检查是否有结果
        if (!data || !data.headers || !data.rows || data.rows.length === 0) {
            resultContainer.classList.remove('hidden');
            emptyResult.classList.remove('hidden');
            resultTable.classList.add('hidden');
            paginationControls.classList.add('hidden');
            resultStats.classList.add('hidden');
            resultCount.textContent = `(0 ${translations[currentLang]['records']})`;
            return;
        }

        // 保存原始数据
        originalData = [...data.rows];
        filteredData = [...data.rows];

        // 重置分页和排序
        currentPage = 1;
        pageSize = parseInt(document.getElementById('pageSize').value);
        sortField = null;
        sortDirection = 'asc';

        // 显示结果
        resultContainer.classList.remove('hidden');
        emptyResult.classList.add('hidden');
        resultTable.classList.remove('hidden');
        paginationControls.classList.remove('hidden');
        resultStats.classList.remove('hidden');

        // 生成表头
        data.headers.forEach((header, index) => {
            const th = document.createElement('th');
            th.setAttribute('scope', 'col');
            th.className = 'px-6 py-4 text-left text-xs font-medium text-primary tracking-wider table-header-cell table-cell-border sortable-header';
            th.innerHTML = `${header} <i class="fa fa-sort ml-1 text-primary/60"></i>`;
            th.addEventListener('click', () => handleSort(index));
            tableHeader.appendChild(th);
        });

        // 渲染表格
        renderTable();

        // 更新分页控件
        updatePagination();

        // 更新统计信息
        updateResultStats();

        // 更新记录数
        resultCount.textContent = `(${data.rows.length.toLocaleString()} ${translations[currentLang]['records']})`;

        // 显示成功提示
        showToast(`${translations[currentLang]['toast-execute-success']}, ${data.rows.length.toLocaleString()} ${translations[currentLang]['records']}`);
    }

    // 渲染表格（分页）
    function renderTable() {
        const tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = '';

        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = Math.min(startIndex + pageSize, filteredData.length);
        const currentPageData = filteredData.slice(startIndex, endIndex);

        // 生成表格内容
        currentPageData.forEach((row, rowIndex) => {
            const tr = document.createElement('tr');
            tr.className = 'animate-fade-in';
            tr.style.animationDelay = `${rowIndex * 50}ms`;

            row.forEach((cell, cellIndex) => {
                const td = document.createElement('td');
                td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500 border-b border-gray-200';

                // 根据数据类型应用不同的样式
                if (typeof cell === 'number' || (typeof cell === 'string' && !isNaN(parseFloat(cell)))) {
                    td.classList.add('number-cell');
                } else if (typeof cell === 'boolean') {
                    td.classList.add('text-center');
                } else {
                    td.classList.add('text-left');
                }

                // 特殊处理状态类数据
                if (document.getElementById('tableHeader').children[cellIndex].textContent.toLowerCase() === 'status') {
                    const statusClass = getStatusClass(cell);
                    td.innerHTML = `<span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">${cell}</span>`;
                } else {
                    td.textContent = cell;
                }

                tr.appendChild(td);
            });

            tableBody.appendChild(tr);
        });
    }

    // 根据状态值返回对应的Tailwind类
    function getStatusClass(status) {
        const statusMap = {
            'active': 'bg-green-100 text-green-800',
            'inactive': 'bg-gray-100 text-gray-800',
            'pending': 'bg-yellow-100 text-yellow-800',
            'deleted': 'bg-red-100 text-red-800'
        };
        return statusMap[status] || 'bg-gray-100 text-gray-800';
    }

    // 更新分页控件
    function updatePagination() {
        const pageNumbers = document.getElementById('pageNumbers');
        const firstPage = document.getElementById('firstPage');
        const prevPage = document.getElementById('prevPage');
        const nextPage = document.getElementById('nextPage');
        const lastPage = document.getElementById('lastPage');

        pageNumbers.innerHTML = '';

        const totalPages = getTotalPages();

        // 启用/禁用按钮
        firstPage.disabled = currentPage === 1;
        prevPage.disabled = currentPage === 1;
        nextPage.disabled = currentPage === totalPages;
        lastPage.disabled = currentPage === totalPages;

        // 生成页码
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = startPage + maxVisiblePages - 1;

        if (endPage > totalPages) {
            endPage = totalPages;
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }

        // 添加第一页按钮
        if (startPage > 1) {
            addPageButton(1);
            if (startPage > 2) {
                addEllipsis();
            }
        }

        // 添加可见页码
        for (let i = startPage; i <= endPage; i++) {
            addPageButton(i);
        }

        // 添加最后一页按钮
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                addEllipsis();
            }
            addPageButton(totalPages);
        }

        function addPageButton(pageNum) {
            const button = document.createElement('button');
            button.className = `px-3 py-1.5 rounded-lg mx-1 ${pageNum === currentPage ? 'bg-primary text-white' : 'bg-gray-100 hover:bg-gray-200'}`;
            button.textContent = pageNum;
            button.addEventListener('click', () => {
                currentPage = pageNum;
                renderTable();
                updatePagination();
            });
            pageNumbers.appendChild(button);
        }

        function addEllipsis() {
            const ellipsis = document.createElement('span');
            ellipsis.className = 'px-3 py-1.5 text-gray-500';
            ellipsis.textContent = '...';
            pageNumbers.appendChild(ellipsis);
        }
    }

    // 获取总页数
    function getTotalPages() {
        return Math.ceil(filteredData.length / pageSize);
    }

    // 更新统计信息
    function updateResultStats() {
        document.getElementById('totalRecords').textContent = originalData.length.toLocaleString();
        document.getElementById('totalColumns').textContent = document.getElementById('tableHeader').children.length;
        document.getElementById('filteredRecords').textContent = filteredData.length.toLocaleString();
    }

    // 处理排序
    function handleSort(columnIndex) {
        const headers = document.getElementById('tableHeader').children;

        // 重置所有表头的排序图标
        for (let i = 0; i < headers.length; i++) {
            if (i !== columnIndex) {
                headers[i].innerHTML = `${headers[i].textContent.replace(/<i[^>]*>/g, '').trim()} <i class="fa fa-sort ml-1 text-primary/60"></i>`;
            }
        }

        // 设置当前表头的排序图标
        if (sortField === columnIndex) {
            // 切换排序方向
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            // 设置新的排序字段
            sortField = columnIndex;
            sortDirection = 'asc';
        }

        // 更新表头图标
        const iconClass = sortDirection === 'asc' ? 'fa-sort-asc' : 'fa-sort-desc';
        headers[columnIndex].innerHTML = `${headers[columnIndex].textContent.replace(/<i[^>]*>/g, '').trim()} <i class="fa ${iconClass} ml-1 text-primary"></i>`;

        // 排序数据
        filteredData.sort((a, b) => {
            const valueA = a[sortField];
            const valueB = b[sortField];

            // 尝试将值转换为数字进行比较
            const numA = parseFloat(valueA);
            const numB = parseFloat(valueB);

            if (!isNaN(numA) && !isNaN(numB)) {
                return sortDirection === 'asc' ? numA - numB : numB - numA;
            }

            // 如果不能转换为数字，则按字符串比较
            return sortDirection === 'asc'
                ? valueA.toString().localeCompare(valueB.toString())
                : valueB.toString().localeCompare(valueA.toString());
        });

        // 重置分页并重新渲染表格
        currentPage = 1;
        renderTable();
        updatePagination();
    }

    // 下载结果
    function downloadResults(format) {
        const resultTable = document.getElementById('resultTable');
        if (resultTable.innerHTML.trim()) {
            let content, contentType, fileName;

            switch (format) {
                case 'csv':
                    content = getTableCSV(resultTable);
                    contentType = 'text/csv;charset=utf-8;';
                    fileName = `${translations[currentLang]['es-query-result']}-${Math.floor(Date.now() / 1000)}.csv`;
                    break;
                case 'json':
                    content = getTableJSON(resultTable);
                    contentType = 'application/json;charset=utf-8;';
                    fileName = `${translations[currentLang]['es-query-result']}-${Math.floor(Date.now() / 1000)}.json`;
                    break;
                case 'excel':
                    content = getTableExcel(resultTable);
                    contentType = 'pplication/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
                    fileName = `${translations[currentLang]['es-query-result']}-${Math.floor(Date.now() / 1000)}.xlsx`;
                    break;
                default:
                    content = getTableCSV(resultTable);
                    contentType = 'text/csv;charset=utf-8;';
                    fileName = `es_query_result_${new Date().toISOString().slice(0, 10)}.csv`;
            }

            const blob = new Blob([content], {type: contentType});
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', fileName);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast(`${translations[currentLang]['downloading']} ${fileName}`);
        }
    }

    // 获取表格 Excel 内容
    function getTableExcel(table) {
        const wb = XLSX.utils.book_new();
        const wsData = [];

        const headerCells = table.rows[0].cells;
        const headerRow = [];
        for (let i = 0; i < headerCells.length; i++) {
            headerRow.push(headerCells[i].textContent.trim());
        }
        wsData.push(headerRow);

        for (let i = 1; i < table.rows.length; i++) {
            const cells = table.rows[i].cells;
            const dataRow = [];
            for (let j = 0; j < cells.length; j++) {
                // 处理可能存在的 span 元素
                const span = cells[j].querySelector('span');
                dataRow.push(span ? span.textContent.trim() : cells[j].textContent.trim());
            }
            wsData.push(dataRow);
        }

        const ws = XLSX.utils.aoa_to_sheet(wsData);
        XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
        return XLSX.write(wb, {bookType: 'xlsx', type: 'array'});
    }

    // 获取表格 JSON 内容
    function getTableJSON(table) {
        const headers = [];
        const rows = [];

        // 获取表头
        const headerCells = table.rows[0].cells;
        for (let i = 0; i < headerCells.length; i++) {
            headers.push(headerCells[i].textContent.trim());
        }

        // 获取数据行
        for (let i = 1; i < table.rows.length; i++) {
            const row = {};
            const cells = table.rows[i].cells;

            for (let j = 0; j < cells.length; j++) {
                // 处理状态标签
                let cellValue = cells[j].textContent.trim();
                if (cells[j].querySelector('span')) {
                    cellValue = cells[j].querySelector('span').textContent.trim();
                }

                row[headers[j]] = cellValue;
            }

            rows.push(row);
        }

        return JSON.stringify(rows, null, 2);
    }

    // 获取表格 CSV 内容
    function getTableCSV(table) {
        let csv = '';

        // 添加表头
        const headerCells = table.rows[0].cells;
        for (let i = 0; i < headerCells.length; i++) {
            let cellText = headerCells[i].textContent.replace(/"/g, '""');
            if (cellText.includes(',') || cellText.includes('\n')) {
                cellText = `"${cellText}"`;
            }
            csv += cellText + (i === headerCells.length - 1 ? '\n' : ',');
        }

        // 添加数据行
        for (let i = 1; i < table.rows.length; i++) {
            const cells = table.rows[i].cells;
            for (let j = 0; j < cells.length; j++) {
                // 处理状态标签
                let cellValue = cells[j].textContent.trim();
                if (cells[j].querySelector('span')) {
                    cellValue = cells[j].querySelector('span').textContent.trim();
                }

                let cellText = cellValue.replace(/"/g, '""');
                if (cellText.includes(',') || cellText.includes('\n')) {
                    cellText = `"${cellText}"`;
                }
                csv += cellText + (j === cells.length - 1 ? '\n' : ',');
            }
        }

        return csv;
    }

    // 获取表格文本
    function getTableText(table) {
        let text = '';
        const rows = table.rows;
        for (let i = 0; i < rows.length; i++) {
            const cells = rows[i].cells;
            for (let j = 0; j < cells.length; j++) {
                // 处理状态标签
                let cellValue = cells[j].textContent.trim();
                if (cells[j].querySelector('span')) {
                    cellValue = cells[j].querySelector('span').textContent.trim();
                }

                text += cellValue + (j === cells.length - 1 ? '\n' : '\t');
            }
        }
        return text;
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', function () {
        updateLanguage(currentLang);
    });
</script>
</body>

</html>