<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elasticsearch SQL Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#0FC6C2',
                        success: '#00B42A',
                        warning: '#FF7D00',
                        danger: '#F53F3F',
                        dark: '#1D2129',
                        light: '#F2F3F5'
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                },
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }

            .bg-gradient-primary {
                background: linear-gradient(135deg, #165DFF 0%, #0A44C0 100%);
            }

            .text-shadow {
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            .transition-all-300 {
                transition: all 300ms ease-in-out;
            }

            .card-hover {
                @apply hover:shadow-lg hover:-translate-y-1 transition-all duration-300;
            }

            .table-cell-border {
                @apply border-r border-gray-200;
            }

            .table-header-cell {
                @apply bg-primary/10 text-primary font-semibold py-4;
            }

            .pagination-active {
                @apply bg-primary text-white;
            }

            .animate-fade-in {
                animation: fadeIn 0.3s ease-out forwards;
            }

            .sortable-header {
                @apply cursor-pointer hover:bg-primary/20 transition-colors duration-150;
            }

            /* Table alignment styles */
            .table-cell-align-left {
                @apply text-left;
            }

            .table-cell-align-right {
                @apply text-right;
            }

            .table-cell-align-center {
                @apply text-center;
            }

            /* History record styles */
            .history-item {
                @apply px-4 py-3 hover:bg-gray-100 cursor-pointer transition-colors duration-150 text-sm;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Custom table styles */
        .result-table {
            @apply min-w-full divide-y divide-gray-200;
        }

        .result-table thead th {
            @apply px-6 py-4 text-left text-xs font-medium text-primary tracking-wider table-header-cell table-cell-border sortable-header;
        }

        .result-table tbody td {
            @apply px-6 py-4 whitespace-nowrap text-sm text-gray-500 border-b border-gray-200;
        }

        .result-table tbody tr:hover {
            @apply bg-gray-50;
        }

        /* Number column alignment styles */
        .number-cell {
            @apply text-left font-mono;
        }

        #historyDropdown::-webkit-scrollbar {
            width: 6px;
        }

        #historyDropdown::-webkit-scrollbar-thumb {
            background-color: #c5c5c5;
            border-radius: 3px;
        }

        #historyDropdown::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .result-table thead th {
            @apply border-r border-gray-200;
            /* Table header column separators */
        }

        .result-table tbody td {
            @apply border-r border-gray-200;
            /* Data column separators */
        }
    </style>
</head>

<body class="font-inter bg-gray-50 text-dark min-h-screen flex flex-col">
<div id="toastContainer" class="fixed top-4 right-4 z-[9999]"></div>
<!-- Navigation Bar -->
<nav class="bg-white shadow-md sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
        <div class="flex items-center space-x-2">
            <i class="fa fa-search text-primary text-2xl"></i>
            <h1 class="text-xl font-bold text-primary"><span data-lang="app-title">Elasticsearch SQL Tool</span></h1>
        </div>
        <div class="flex items-center space-x-4">
            <div class="relative">
                <select id="langToggle"
                        class="appearance-none bg-gray-100 border border-gray-200 rounded-lg py-2 pl-3 pr-8 focus:outline-none focus:ring-2 focus:ring-primary/50">
                    <option value="en">English</option>
                    <option value="zh">中文</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-dark">
                    <i class="fa fa-chevron-down text-xs"></i>
                </div>
            </div>
        </div>
    </div>
</nav>

<!-- Main Content Area -->
<main class="flex-grow container mx-auto px-4 py-8">
    <!-- Query Area -->
    <div class="bg-white rounded-xl shadow-md p-6 mb-8 transform transition-all duration-200 hover:shadow-lg">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold text-dark flex items-center">
                <i class="fa fa-code text-primary mr-2"></i>
                <span data-lang="query-area">SQL Area</span>
            </h2>
            <div class="flex space-x-2">
                <button id="clearBtn"
                        class="px-3 py-1.5 bg-gray-100 hover:bg-gray-300 text-dark rounded-lg transition-all-300 flex items-center">
                    <i class="fa fa-trash-o mr-1"></i>
                    <span data-lang="clear">Clear</span>
                </button>
                <!-- History Record Button -->
                <div class="relative">
                    <button id="historyBtn"
                            class="px-3 py-1.5 bg-gray-100 hover:bg-gray-300 text-dark rounded-lg transition-all-300 flex items-center">
                        <i class="fa fa-history mr-1"></i>
                        <span data-lang="history">History</span>
                    </button>
                    <!-- History Record Dropdown Menu - Added max-h-60 and overflow-y-auto classes -->
                    <div id="historyDropdown"
                         class="absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl z-50 max-h-60 overflow-y-auto hidden">
                        <div class="p-2 border-b border-gray-200 sticky top-0 bg-white">
                            <h4 class="text-sm font-medium text-gray-900" data-lang="recent-queries">Recent Queries</h4>
                        </div>
                        <div id="historyList" class="divide-y divide-gray-100"></div>
                        <div class="p-2 border-t border-gray-200 flex justify-end sticky bottom-0 bg-white">
                            <button id="clearHistoryBtn" class="text-xs text-red-500 hover:text-red-700">
                                <i class="fa fa-trash mr-1"></i>
                                <span data-lang="clear-history">Clear All</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-4">
            <div class="relative">
                <textarea id="sqlQuery"
                          class="w-full h-32 p-4 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 font-mono"
                          placeholder="Input SQL ..."></textarea>
                <div class="absolute right-3 bottom-3 text-xs text-gray-400">
                    <span id="charCount">20</span> <span data-lang="characters">characters</span>
                </div>
            </div>
        </div>

        <div class="flex justify-end">
            <button id="executeBtn"
                    class="bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-lg shadow-md hover:shadow-lg transition-all-300 flex items-center">
                <i class="fa fa-play mr-2"></i>
                <span data-lang="execute">Execute SQL</span>
            </button>
        </div>
    </div>

    <!-- DML Result Area -->
    <div id="dmlResultContainer" class="bg-white rounded-xl shadow-md p-6 mb-8 hidden">
        <div class="flex items-center">
            <div class="mr-4 text-2xl">
                <i id="dmlResultIcon" class="fa fa-check-circle text-success"></i>
            </div>
            <div>
                <h3 class="text-lg font-semibold" id="dmlResultTitle" data-lang="dml-success">Operation Successful</h3>
                <div class="mt-1">
                    <div id="dmlDetails" class="mt-3 hidden">
                        <pre id="dmlResultDetails"
                             class="bg-gray-50 p-3 rounded-lg text-xs font-mono overflow-x-auto"></pre>
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-4 flex justify-end">
            <button id="viewDetailsBtn" class="text-primary hover:text-primary/80 flex items-center">
                <span data-lang="view-details">View Details</span>
                <i class="fa fa-chevron-down ml-1"></i>
            </button>
        </div>
    </div>

    <!-- Query Result Area -->
    <div id="queryResultContainer"
         class="bg-white rounded-xl shadow-md p-6 mb-8 hidden transform transition-all duration-300 hover:shadow-lg">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold text-dark flex items-center">
                <i class="fa fa-table text-primary mr-2"></i>
                <span data-lang="result">Query Result</span>
                <span id="resultCount" class="ml-2 text-sm text-gray-500">(0 <span
                        data-lang="records">records</span>)</span>
            </h2>
            <div class="flex space-x-2">
                <button id="copyBtn"
                        class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-dark rounded-lg transition-all-300 flex items-center">
                    <i class="fa fa-copy mr-1"></i>
                    <span data-lang="copy">Copy</span>
                </button>
                <div class="relative">
                    <button id="downloadBtn"
                            class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-dark rounded-lg transition-all-300 flex items-center">
                        <i class="fa fa-download mr-1"></i>
                        <span data-lang="download">Download</span>
                    </button>
                    <div id="downloadMenu"
                         class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 hidden z-10">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-format="csv">CSV</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-format="json">JSON</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-format="excel">Excel</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Box -->
        <div class="mb-4">
            <div class="relative">
                <input type="text" id="searchInput" placeholder="Search..."
                       class="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 pl-10">
                <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                    <i class="fa fa-search"></i>
                </div>
            </div>
        </div>

        <!-- Result Distribution Statistics -->
        <div id="resultStats" class="mb-4 bg-gray-50 p-4 rounded-lg hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center mr-3">
                        <i class="fa fa-database text-primary"></i>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500" data-lang="total-records">Total Records</p>
                        <p class="text-lg font-semibold" id="totalRecords">0</p>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-secondary/10 flex items-center justify-center mr-3">
                        <i class="fa fa-columns text-secondary"></i>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500" data-lang="total-columns">Total Columns</p>
                        <p class="text-lg font-semibold" id="totalColumns">0</p>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-success/10 flex items-center justify-center mr-3">
                        <i class="fa fa-filter text-success"></i>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500" data-lang="filtered-records">Filtered Records</p>
                        <p class="text-lg font-semibold" id="filteredRecords">0</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table id="resultTable" class="result-table">
                <thead>
                <tr id="tableHeader"></tr>
                </thead>
                <tbody id="tableBody" class="bg-white divide-y divide-gray-200"></tbody>
            </table>
        </div>

        <!-- Pagination Controls -->
        <div id="paginationControls" class="mt-6 flex flex-col md:flex-row justify-between items-center hidden">
            <div class="mb-4 md:mb-0">
                <label for="pageSize" class="text-sm text-gray-500 mr-2" data-lang="show">Show</label>
                <select id="pageSize"
                        class="bg-gray-50 border border-gray-200 rounded-lg py-1 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
                <span class="text-sm text-gray-500 ml-2" data-lang="entries">entries</span>
            </div>

            <div class="flex items-center space-x-1">
                <button id="firstPage"
                        class="px-3 py-1.5 rounded-lg border border-gray-200 text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fa fa-angle-double-left"></i>
                </button>
                <button id="prevPage"
                        class="px-3 py-1.5 rounded-lg border border-gray-200 text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fa fa-angle-left"></i>
                </button>
                <div id="pageNumbers" class="flex"></div>
                <button id="nextPage"
                        class="px-3 py-1.5 rounded-lg border border-gray-200 text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fa fa-angle-right"></i>
                </button>
                <button id="lastPage"
                        class="px-3 py-1.5 rounded-lg border border-gray-200 text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fa fa-angle-double-right"></i>
                </button>
            </div>
        </div>

        <div id="emptyResult" class="py-12 flex flex-col items-center justify-center hidden">
            <div class="w-16 h-16 mb-4 text-gray-300">
                <i class="fa fa-search fa-4x"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-1" data-lang="no-results">No results found</h3>
            <p class="text-gray-500 max-w-md text-center" data-lang="no-results-desc">Try modifying your query or check
                the
                syntax</p>
            <button id="clearSearchBtn"
                    class="mt-4 px-4 py-2 bg-primary/10 text-primary rounded-lg hover:bg-primary/20 transition-colors duration-150">
                <i class="fa fa-times-circle mr-1"></i>
                <span data-lang="clear-search">Clear Search</span>
            </button>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-lg flex items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary mr-4"></div>
            <div>
                <h3 class="font-semibold text-dark" data-lang="loading">Executing query...</h3>
                <p class="text-gray-500 text-sm" data-lang="please-wait">Please wait...</p>
            </div>
        </div>
    </div>

    <!-- Error Display -->
    <div id="errorContainer"
         class="bg-white rounded-xl shadow-md p-6 mb-8 hidden transform transition-all duration-300 hover:shadow-lg">
        <div class="flex items-start">
            <div class="flex-shrink-0 pt-0.5">
                <i class="fa fa-exclamation-triangle text-danger text-xl"></i>
            </div>
            <div class="ml-3 flex-1">
                <h3 class="text-lg font-medium text-danger" data-lang="error-occurred">An error occurred while executing
                    the
                    query</h3>
                <div class="mt-2 text-sm text-gray-700">
                    <p id="errorMessage">Error message will be displayed here</p>
                </div>
                <div class="mt-4">
                    <pre id="errorDetails" class="bg-gray-50 p-3 rounded-lg text-xs font-mono overflow-x-auto"></pre>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Footer -->
<footer class="bg-dark text-white py-6">
    <div class="container mx-auto px-4">
        <div class="flex flex-col md:flex-row justify-between items-center">
            <div class="mb-4 md:mb-0">
                <div class="flex items-center space-x-2">
                    <i class="fa fa-search text-primary"></i>
                    <span class="font-semibold" data-lang="app-title">Elasticsearch SQL Tool</span>
                </div>
            </div>
            <div class="flex space-x-4">
                <a href="https://github.com/junqiangChi/es-sql"
                   class="text-gray-400 hover:text-white transition-colors duration-300">
                    <i class="fa fa-github text-xl"></i>
                </a>
            </div>
        </div>
    </div>
</footer>

<script>
    // Language Pack
    const translations = {
        'en': {
            'app-title': 'Elasticsearch SQL Tool',
            'query-area': 'SQL Area',
            'input-sql': 'Input SQL ...',
            'clear': 'Clear',
            'characters': 'characters',
            'execute': 'Execute SQL',
            'result': 'Query Result',
            'records': 'records',
            'copy': 'Copy',
            'download': 'Download',
            'no-results': 'No results found',
            'no-results-desc': 'Try modifying your SQL or check the syntax',
            'loading': 'Executing SQL...',
            'please-wait': 'Please wait...',
            'error-occurred': 'An error occurred while executing the SQL',
            'all-rights': 'All rights reserved',
            'toast-copied': 'Content copied to clipboard',
            'toast-copy-failed': 'Failed to copy, please copy manually',
            'toast-execute-success': 'SQL executed successfully',
            'toast-execute-failed': 'SQL execution failed',
            'toast-enter-query': 'Please enter an SQL',
            'toast-api-error': 'API call failed',
            'toast-api-error-details': 'Please check the error details',
            'json-format-error': 'There are no headers or rows in the returned JSON results',
            'search-placeholder': 'Search in results...',
            'total-records': 'Total Records',
            'total-columns': 'Total Columns',
            'filtered-records': 'Filtered Records',
            'show': 'Show',
            'reason': 'Reason',
            'entries': 'entries',
            'page': 'Page',
            'of': 'of',
            'clear-search': 'Clear Search',
            'csv-format': 'CSV Format',
            'json-format': 'JSON Format',
            'excel-format': 'Excel Format',
            'downloading': 'Downloading',
            'es-query-result': 'EsQueryResult',
            'dml-success': 'Operation Successful',
            'dml-failure': 'Operation Failed',
            'view-details': 'View Details',
            'hide-details': 'Hide Details',
            'dml-rows-affected': 'Rows affected:',
            'dml-insert-success': 'Data inserted successfully',
            'dml-update-success': 'Data updated successfully',
            'dml-delete-success': 'Data deleted successfully',
            'dml-create-success': 'Index created successfully',
            'dml-alter-success': 'Index altered successfully',
            'dml-drop-success': 'Index dropped successfully',
            'dml-describe-success': 'Index described successfully',
            'dml-show-success': 'Tables listed successfully',
            'history': 'History',
            'recent-queries': 'Recent Queries',
            'clear-history': 'Clear All',
            'no-history': 'No history yet',
            'toast-history-cleared': 'History cleared',
            'toast-history-cleared-error': 'Failed to clear history'
        },
        'zh': {
            'app-title': 'Elasticsearch SQL 工具',
            'query-area': 'SQL区域',
            'input-sql': '输入 SQL ...',
            'clear': '清空',
            'characters': '字符',
            'execute': '执行 SQL',
            'result': '查询结果',
            'records': '记录',
            'copy': '复制',
            'download': '下载',
            'no-results': '没有找到结果',
            'no-results-desc': '尝试修改SQL或检查语法是否正确',
            'loading': '正在执行 SQL...',
            'please-wait': '请稍候...',
            'error-occurred': '执行 SQL 时出错',
            'all-rights': '保留所有权利',
            'toast-copied': '内容已复制到剪贴板',
            'toast-copy-failed': '复制失败，请手动复制',
            'toast-execute-success': 'SQL 执行成功',
            'toast-execute-failed': 'SQL 执行失败',
            'toast-api-error': '接口调用失败',
            'toast-api-error-details': '请查看错误详情',
            'json-format-error': '返回JSO结果中没有headers或者rows',
            'toast-enter-query': '请输入 SQL',
            'search-placeholder': '在结果中搜索...',
            'total-records': '总记录数',
            'total-columns': '总列数',
            'filtered-records': '过滤后记录',
            'show': '显示',
            'reason': '原因',
            'entries': '条记录',
            'page': '第',
            'of': '页，共',
            'clear-search': '清空搜索',
            'csv-format': 'CSV 格式',
            'json-format': 'JSON 格式',
            'excel-format': 'Excel 格式',
            'downloading': '正在下载',
            'es-query-result': 'Es查询结果',
            'dml-success': '操作成功',
            'dml-failure': '操作失败',
            'view-details': '查看详情',
            'hide-details': '隐藏详情',
            'dml-rows-affected': '影响行数:',
            'dml-insert-success': '数据插入成功',
            'dml-update-success': '数据更新成功',
            'dml-delete-success': '数据删除成功',
            'dml-create-success': '索引创建成功',
            'dml-alter-success': '索引修改成功',
            'dml-drop-success': '索引删除成功',
            'dml-describe-success': '索引描述成功',
            'dml-show-success': '表列表获取成功',
            'history': '历史记录',
            'recent-queries': '最近查询',
            'clear-history': '清空全部',
            'no-history': '暂无历史记录',
            'toast-history-cleared': '历史记录已清空',
            'toast-history-cleared-error': '清空历史记录失败'
        }
    };

    const esHost = window.location.hostname || 'localhost';
    const esPort = window.location.port || '9200';

    // Pagination related variables
    let currentPage = 1;
    let pageSize = 10;
    let filteredData = [];
    let originalData = [];
    let sortField = null;
    let sortDirection = 'asc';

    // Current language
    let currentLang = 'en';

    const MAX_HISTORY = 10;
    let queryHistory = [];

    // Initialize history records
    function initHistory() {
        try {
            const savedHistory = localStorage.getItem('sqlHistory');
            if (savedHistory) {
                queryHistory = JSON.parse(savedHistory);
                renderHistory();
            }
        } catch (e) {
            console.error('Failed to load history:', e);
        }
    }

    // Save history records to local storage
    function saveHistory() {
        try {
            localStorage.setItem('sqlHistory', JSON.stringify(queryHistory));
        } catch (e) {
            console.error('Failed to save history:', e);
        }
    }

    // Add query to history records
    function addToHistory(sql) {
        // Clean SQL (remove extra spaces)
        const cleanedSql = sql.trim();

        // If SQL is empty, don't add it
        if (!cleanedSql) return;

        // Check if the same query already exists
        const existingIndex = queryHistory.findIndex(item => item.sql === cleanedSql);

        // If it exists, remove the old record
        if (existingIndex !== -1) {
            queryHistory.splice(existingIndex, 1);
        }

        // Add new record to the beginning of the array
        queryHistory.unshift({
            sql: cleanedSql,
            timestamp: new Date().toISOString()
        });

        // Limit the number of history records
        if (queryHistory.length > MAX_HISTORY) {
            queryHistory.pop();
        }

        // Save to local storage
        saveHistory();

        // Re-render the history record list
        renderHistory();

    }

    // Render history record list
    function renderHistory() {
        const historyList = document.getElementById('historyList');
        historyList.innerHTML = '';

        if (queryHistory.length === 0) {
            const emptyItem = document.createElement('div');
            emptyItem.className = 'history-item text-center text-gray-500 py-6';
            emptyItem.textContent = translations[currentLang]['no-history'];
            historyList.appendChild(emptyItem);
            return;
        }

        queryHistory.forEach((historyItem, index) => {
            const historyElement = document.createElement('div');
            historyElement.className = 'history-item';
            historyElement.dataset.index = index;

            // Format time
            const date = new Date(historyItem.timestamp);
            const timeString = date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});

            historyElement.innerHTML = `
            <div class="flex justify-between items-start">
                <div class="font-medium text-gray-800 truncate flex-1 pr-2">${historyItem.sql}</div>
                <div class="text-xs text-gray-500 mt-0.5 flex-shrink-0">${timeString}</div>
            </div>
        `;

            historyElement.addEventListener('click', () => {
                document.getElementById('sqlQuery').value = historyItem.sql;
                document.getElementById('charCount').textContent = historyItem.sql.length;
                document.getElementById('historyDropdown').classList.add('hidden');
            });

            historyList.appendChild(historyElement);
        });
    }

    // Clear history records
    function clearHistory() {
        try {
            queryHistory = [];
            localStorage.removeItem('sqlHistory');
            renderHistory();
            showToast(translations[currentLang]['toast-history-cleared'], 'success');
        } catch (e) {
            console.error('Failed to clear history:', e);
            showToast(translations[currentLang]['toast-history-cleared-error'], 'error');
        }
    }

    // Add initialization of history records in DOMContentLoaded event
    document.addEventListener('DOMContentLoaded', function () {
        updateLanguage(currentLang);
        initHistory();  // Initialize history records

        // History record button click event
        document.getElementById('historyBtn').addEventListener('click', function (e) {
            e.stopPropagation();
            const dropdown = document.getElementById('historyDropdown');
            dropdown.classList.toggle('hidden');
        });

        // Click other areas of the page to close the history record dropdown menu
        document.addEventListener('click', function (e) {
            if (!document.getElementById('historyBtn').contains(e.target) &&
                !document.getElementById('historyDropdown').contains(e.target)) {
                document.getElementById('historyDropdown').classList.add('hidden');
            }
        });

        // Clear history record button event
        document.getElementById('clearHistoryBtn').addEventListener('click', function (e) {
            e.stopPropagation();
            clearHistory();
        });
    });

    // Update interface language
    function updateLanguage(lang) {
        currentLang = lang;
        document.querySelectorAll('[data-lang]').forEach(el => {
            const key = el.getAttribute('data-lang');
            if (translations[lang][key]) {
                el.textContent = translations[lang][key];
            }
        });

        // Update search box placeholder
        document.getElementById('searchInput').placeholder = translations[lang]['search-placeholder'];
        // Update input box placeholder
        document.getElementById("sqlQuery").placeholder = translations[lang]['input-sql']

        // Update download menu
        document.querySelectorAll('#downloadMenu a').forEach(link => {
            const format = link.getAttribute('data-format');
            if (format === 'csv') {
                link.textContent = translations[lang]['csv-format'];
            } else if (format === 'json') {
                link.textContent = translations[lang]['json-format'];
            } else if (format === 'excel') {
                link.textContent = translations[lang]['excel-format'];
            }
        });

        // Update language selector
        document.getElementById('langToggle').value = lang;
    }

    // Character count
    const sqlQuery = document.getElementById('sqlQuery');
    const charCount = document.getElementById('charCount');

    sqlQuery.addEventListener('input', function () {
        charCount.textContent = this.value.length;
    });

    // Execute SQL
    document.getElementById('executeBtn').addEventListener('click', executeQuery);

    // Clear button
    document.getElementById('clearBtn').addEventListener('click', function () {
        sqlQuery.value = '';
        charCount.textContent = '0';
    });

    // Language switch
    document.getElementById('langToggle').addEventListener('change', function () {
        updateLanguage(this.value);
    });

    // Copy results
    document.getElementById('copyBtn').addEventListener('click', function () {
        const resultTable = document.getElementById('resultTable');
        if (resultTable.innerHTML.trim()) {
            const textToCopy = getTableText(resultTable);
            navigator.clipboard.writeText(textToCopy).then(function () {
                showToast(translations[currentLang]['toast-copied']);
            }).catch(function (err) {
                showToast(translations[currentLang]['toast-copy-failed'], 'error');
            });
        }
    });

    // Download results
    document.getElementById('downloadBtn').addEventListener('click', function (e) {
        e.stopPropagation();
        document.getElementById('downloadMenu').classList.toggle('hidden');
    });

    // Download format selection
    document.querySelectorAll('#downloadMenu a').forEach(link => {
        link.addEventListener('click', function (e) {
            e.preventDefault();
            const format = this.getAttribute('data-format');
            downloadResults(format);
            document.getElementById('downloadMenu').classList.add('hidden');
        });
    });

    // Click other areas to close download menu
    document.addEventListener('click', function (e) {
        if (!document.getElementById('downloadBtn').contains(e.target)) {
            document.getElementById('downloadMenu').classList.add('hidden');
        }
    });

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', function () {
        const searchTerm = this.value.toLowerCase().trim();
        if (!originalData || originalData.length === 0) return;

        if (searchTerm === '') {
            filteredData = [...originalData];
        } else {
            filteredData = originalData.filter(row => {
                return row.some(cell =>
                    cell.toString().toLowerCase().includes(searchTerm)
                );
            });
        }

        currentPage = 1;
        renderTable();
        updatePagination();
        updateResultStats();
    });

    // Clear search
    document.getElementById('clearSearchBtn').addEventListener('click', function () {
        document.getElementById('searchInput').value = '';
        filteredData = [...originalData];
        currentPage = 1;
        renderTable();
        updatePagination();
        updateResultStats();
    });

    // Pagination related events
    document.getElementById('pageSize').addEventListener('change', function () {
        pageSize = parseInt(this.value);
        currentPage = 1;
        renderTable();
        updatePagination();
    });

    document.getElementById('firstPage').addEventListener('click', function () {
        if (currentPage > 1) {
            currentPage = 1;
            renderTable();
            updatePagination();
        }
    });

    document.getElementById('prevPage').addEventListener('click', function () {
        if (currentPage > 1) {
            currentPage--;
            renderTable();
            updatePagination();
        }
    });

    document.getElementById('nextPage').addEventListener('click', function () {
        if (currentPage < getTotalPages()) {
            currentPage++;
            renderTable();
            updatePagination();
        }
    });

    document.getElementById('lastPage').addEventListener('click', function () {
        const totalPages = getTotalPages();
        if (currentPage < totalPages) {
            currentPage = totalPages;
            renderTable();
            updatePagination();
        }
    });

    // View details button
    document.getElementById('viewDetailsBtn').addEventListener('click', function () {
        const detailsEl = document.getElementById('dmlDetails');
        const iconEl = this.querySelector('i');

        if (detailsEl.classList.contains('hidden')) {
            detailsEl.classList.remove('hidden');
            iconEl.classList.remove('fa-chevron-down');
            iconEl.classList.add('fa-chevron-up');
            this.querySelector('span').textContent = translations[currentLang]['hide-details'] || 'Hide Details';
        } else {
            detailsEl.classList.add('hidden');
            iconEl.classList.remove('fa-chevron-up');
            iconEl.classList.add('fa-chevron-down');
            this.querySelector('span').textContent = translations[currentLang]['view-details'];
        }
    });

    async function callApi(sql) {
        try {
            try {
                const apiUrl = `http://${esHost}:${esPort}/web_sql_exec`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({"sql": sql})
                });

                // Handle different types of responses
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error(errorData);
                    throw new Error(errorData.error?.reason || 'Unknown error');
                }

                // Try to parse as JSON
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return await response.json();
                } else {
                    return await response.text();
                }
            } catch (error) {
                throw error;
            }
        } catch (error) {
            throw error;
        }
    }

    // Execute SQL function
    function executeQuery() {
        const sql = sqlQuery.value.trim();
        if (!sql) {
            showToast(translations[currentLang]['toast-enter-query'], 'warning');
            return;
        }
        // Add to history records
        addToHistory(sql);

        // Show loading state
        document.getElementById('loadingIndicator').classList.remove('hidden');
        document.getElementById('queryResultContainer').classList.add('hidden');
        document.getElementById('dmlResultContainer').classList.add('hidden');
        document.getElementById('errorContainer').classList.add('hidden');

        callApi(sql)
            .then(data => {
                document.getElementById('loadingIndicator').classList.add('hidden');
                // Determine if it's a query result or DML result
                if (isQueryResult(sql)) {
                    processQueryResult(data);
                } else {
                    processDmlResult(sql, data);
                }
            })
            .catch(error => {
                document.getElementById('loadingIndicator').classList.add('hidden');
                // Show detailed error information
                document.getElementById('errorContainer').classList.remove('hidden');
                document.getElementById('errorMessage').textContent = error.message;
                document.getElementById('errorDetails').textContent = error.stack || error.message;
            });
    }

    // Determine if it's a query result
    function isQueryResult(sql) {
        return sql.toUpperCase().startsWith("SELECT") || sql.toUpperCase().startsWith("SHOW")
    }

    // Process DML results
    function processDmlResult(sql, data) {
        const dmlResultContainer = document.getElementById('dmlResultContainer');
        const dmlResultTitle = document.getElementById('dmlResultTitle');
        const dmlResultIcon = document.getElementById('dmlResultIcon');
        const dmlResultDetails = document.getElementById('dmlResultDetails');
        const dmlDetails = document.getElementById('dmlDetails');
        const viewDetailsBtn = document.getElementById('viewDetailsBtn');

        // Reset UI state
        dmlDetails.classList.add('hidden');
        viewDetailsBtn.querySelector('i').className = 'fa fa-chevron-down ml-1';
        viewDetailsBtn.querySelector('span').textContent = translations[currentLang]['view-details'];

        // Show DML result container
        dmlResultContainer.classList.remove('hidden');

        // Determine operation type
        const sqlType = sql.trim().substring(0, 6).toUpperCase();
        let message = '';
        let title = translations[currentLang]['dml-success'];
        let iconClass = 'fa-check-circle text-success';

        // Set different messages based on SQL type
        if (sqlType.includes('INSERT')) {
            message = translations[currentLang]['dml-insert-success'];
        } else if (sqlType.includes('UPDATE')) {
            message = translations[currentLang]['dml-update-success'];
        } else if (sqlType.includes('DELETE')) {
            message = translations[currentLang]['dml-delete-success'];
        } else if (sqlType.includes('CREATE')) {
            message = translations[currentLang]['dml-create-success'];
        } else if (sqlType.includes('ALTER')) {
            message = translations[currentLang]['dml-alter-success'];
        } else if (sqlType.includes('DROP')) {
            message = translations[currentLang]['dml-drop-success'];
        } else if (sqlType.includes('DESCRIBE') || sqlType.includes('DESC')) {
            message = translations[currentLang]['dml-describe-success'];
        } else if (sqlType.includes('SHOW')) {
            message = translations[currentLang]['dml-show-success'];
        } else {
            message = translations[currentLang]['dml-success'];
        }

        // If there is row count information
        if (data && typeof data === 'object' && data.effectRows !== undefined) {
            message += ` ${translations[currentLang]['dml-rows-affected']} ${data.effectRows}`;
        }

        // Update UI
        dmlResultTitle.textContent = title;
        dmlResultIcon.className = `fa ${iconClass} text-2xl`;

        // Set detailed results
        if (data) {
            dmlResultDetails.textContent = typeof data === 'object'
                ? JSON.stringify(data, null, 2)
                : data;
        }

        // Show success message
        showToast(message);
    }

    // Process query results
    function processQueryResult(data) {
        const queryResultContainer = document.getElementById('queryResultContainer');
        const resultTable = document.getElementById('resultTable');
        const tableHeader = document.getElementById('tableHeader');
        const tableBody = document.getElementById('tableBody');
        const resultCount = document.getElementById('resultCount');
        const emptyResult = document.getElementById('emptyResult');
        const paginationControls = document.getElementById('paginationControls');
        const resultStats = document.getElementById('resultStats');

        // Clear table
        tableHeader.innerHTML = '';
        tableBody.innerHTML = '';

        // Check if there are results
        if (!data || !data.headers || !data.rows || data.rows.length === 0) {
            queryResultContainer.classList.remove('hidden');
            emptyResult.classList.remove('hidden');
            resultTable.classList.add('hidden');
            paginationControls.classList.add('hidden');
            resultStats.classList.add('hidden');
            resultCount.textContent = `(0 ${translations[currentLang]['records']})`;
            return;
        }

        // Save original data
        originalData = [...data.rows];
        filteredData = [...data.rows];

        // Reset pagination and sorting
        currentPage = 1;
        pageSize = parseInt(document.getElementById('pageSize').value);
        sortField = null;
        sortDirection = 'asc';

        // Show results
        queryResultContainer.classList.remove('hidden');
        emptyResult.classList.add('hidden');
        resultTable.classList.remove('hidden');
        paginationControls.classList.remove('hidden');
        resultStats.classList.remove('hidden');

        // Generate table headers
        data.headers.forEach((header, index) => {
            const th = document.createElement('th');
            th.setAttribute('scope', 'col');
            th.className = 'px-6 py-4 text-left text-xs font-medium text-primary tracking-wider table-header-cell table-cell-border sortable-header';
            th.innerHTML = `${header} <i class="fa fa-sort ml-1 text-primary/60"></i>`;
            th.addEventListener('click', () => handleSort(index));
            tableHeader.appendChild(th);
        });

        // Render table
        renderTable();

        // Update pagination controls
        updatePagination();

        // Update statistics
        updateResultStats();

        // Update record count
        resultCount.textContent = `(${data.rows.length.toLocaleString()} ${translations[currentLang]['records']})`;

        // Show success message
        showToast(`${translations[currentLang]['toast-execute-success']}, ${data.rows.length.toLocaleString()} ${translations[currentLang]['records']}`);
    }

    function showToast(message, type = 'success', details = '') {
        // Create toast element
        const toast = document.createElement('div');

        // Set styles and classes
        let bgColor, textColor, icon;
        switch (type) {
            case 'error':
                bgColor = 'bg-danger';
                textColor = 'text-white';
                icon = 'fa-exclamation-circle';
                break;
            case 'warning':
                bgColor = 'bg-warning';
                textColor = 'text-white';
                icon = 'fa-exclamation-triangle';
                break;
            case 'success':
            default:
                bgColor = 'bg-success';
                textColor = 'text-white';
                icon = 'fa-check-circle';
                break;
        }

        toast.className = `mb-2 ${bgColor} ${textColor} px-6 py-3 rounded-lg shadow-lg z-50 flex items-center transform transition-all duration-300 translate-y-20 opacity-0 max-w-md`;

        // Set content
        toast.innerHTML = `
        <i class="fa ${icon} mr-2 text-xl"></i>
        <div class="flex-1">
          <div class="font-medium">${message}</div>
          ${details ? `<div class="text-xs mt-1 opacity-80">${details}</div>` : ''}
        </div>
        <button class="ml-4 close-toast">
          <i class="fa fa-times"></i>
        </button>
      `;

        // Add to container
        const container = document.getElementById('toastContainer');
        container.appendChild(toast);

        // Show animation
        setTimeout(() => {
            toast.classList.remove('translate-y-20', 'opacity-0');
            toast.classList.add('translate-y-0', 'opacity-100');
        }, 10);

        // Add close button event
        toast.querySelector('.close-toast').addEventListener('click', () => {
            removeToast(toast);
        });

        // Auto close
        const autoCloseTimer = setTimeout(() => {
            removeToast(toast);
        }, 5000);

        // Pause auto close when mouse hovers
        toast.addEventListener('mouseenter', () => {
            clearTimeout(autoCloseTimer);
        });

        // Reset auto close when mouse leaves
        toast.addEventListener('mouseleave', () => {
            setTimeout(() => {
                removeToast(toast);
            }, 2000);
        });
    }

    function removeToast(toast) {
        toast.classList.add('translate-y-20', 'opacity-0');
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }

    // Render table (with pagination)
    function renderTable() {
        const tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = '';

        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = Math.min(startIndex + pageSize, filteredData.length);
        const currentPageData = filteredData.slice(startIndex, endIndex);

        // Format functions for handling nested objects
        const formatNestedObject = (obj) => {
            if (Array.isArray(obj)) {
                td.textContent = JSON.stringify(cell);
            } else if (obj && typeof obj === 'object') {
                return Object.fromEntries(
                    Object.entries(obj).map(([key, value]) =>
                        [key, formatNestedObject(value)]
                    )
                );
            }
            return obj;
        };

        // Generate table content
        currentPageData.forEach((row, rowIndex) => {
            const tr = document.createElement('tr');
            tr.className = 'animate-fade-in';
            tr.style.animationDelay = `${rowIndex * 50}ms`;

            row.forEach((cell, cellIndex) => {
                const td = document.createElement('td');
                td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500 border-b border-gray-200';

                // 处理不同类型的单元格值
                if (Array.isArray(cell)) {
                    td.textContent = JSON.stringify(cell);
                } else if (typeof cell === 'object' && cell !== null) {
                    td.textContent = JSON.stringify(cell);
                } else {
                    if (typeof cell === 'number' || (typeof cell === 'string' && !isNaN(parseFloat(cell)))) {
                        td.classList.add('number-cell');
                    } else if (typeof cell === 'boolean') {
                        td.classList.add('text-center');
                    } else {
                        td.classList.add('text-left');
                    }

                    if (document.getElementById('tableHeader').children[cellIndex].textContent.toLowerCase() === 'status') {
                        const statusClass = getStatusClass(cell);
                        td.innerHTML = `<span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">${cell}</span>`;
                    } else {
                        td.textContent = cell;
                    }
                }

                tr.appendChild(td);
            });

            tableBody.appendChild(tr);
        });
    }

    // Return corresponding Tailwind classes based on status value
    function getStatusClass(status) {
        const statusMap = {
            'active': 'bg-green-100 text-green-800',
            'inactive': 'bg-gray-100 text-gray-800',
            'pending': 'bg-yellow-100 text-yellow-800',
            'deleted': 'bg-red-100 text-red-800'
        };
        return statusMap[status] || 'bg-gray-100 text-gray-800';
    }

    // Update pagination controls
    function updatePagination() {
        const pageNumbers = document.getElementById('pageNumbers');
        const firstPage = document.getElementById('firstPage');
        const prevPage = document.getElementById('prevPage');
        const nextPage = document.getElementById('nextPage');
        const lastPage = document.getElementById('lastPage');

        pageNumbers.innerHTML = '';

        const totalPages = getTotalPages();

        // Enable/disable buttons
        firstPage.disabled = currentPage === 1;
        prevPage.disabled = currentPage === 1;
        nextPage.disabled = currentPage === totalPages;
        lastPage.disabled = currentPage === totalPages;

        // Generate page numbers
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = startPage + maxVisiblePages - 1;

        if (endPage > totalPages) {
            endPage = totalPages;
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }

        // Add first page button
        if (startPage > 1) {
            addPageButton(1);
            if (startPage > 2) {
                addEllipsis();
            }
        }

        // Add visible page numbers
        for (let i = startPage; i <= endPage; i++) {
            addPageButton(i);
        }

        // Add last page button
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                addEllipsis();
            }
            addPageButton(totalPages);
        }

        function addPageButton(pageNum) {
            const button = document.createElement('button');
            button.className = `px-3 py-1.5 rounded-lg mx-1 ${pageNum === currentPage ? 'bg-primary text-white' : 'bg-gray-100 hover:bg-gray-200'}`;
            button.textContent = pageNum;
            button.addEventListener('click', () => {
                currentPage = pageNum;
                renderTable();
                updatePagination();
            });
            pageNumbers.appendChild(button);
        }

        function addEllipsis() {
            const ellipsis = document.createElement('span');
            ellipsis.className = 'px-3 py-1.5 text-gray-500';
            ellipsis.textContent = '...';
            pageNumbers.appendChild(ellipsis);
        }
    }

    // Get total pages
    function getTotalPages() {
        return Math.ceil(filteredData.length / pageSize);
    }

    // Update statistics
    function updateResultStats() {
        document.getElementById('totalRecords').textContent = originalData.length.toLocaleString();
        document.getElementById('totalColumns').textContent = document.getElementById('tableHeader').children.length;
        document.getElementById('filteredRecords').textContent = filteredData.length.toLocaleString();
    }

    // Handle sorting
    function handleSort(columnIndex) {
        const headers = document.getElementById('tableHeader').children;

        // Reset sorting icons for all headers
        for (let i = 0; i < headers.length; i++) {
            if (i !== columnIndex) {
                headers[i].innerHTML = `${headers[i].textContent.replace(/<i[^>]*>/g, '').trim()} <i class="fa fa-sort ml-1 text-primary/60"></i>`;
            }
        }

        // Set sorting icon for current header
        if (sortField === columnIndex) {
            // Toggle sort direction
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            // Set new sort field
            sortField = columnIndex;
            sortDirection = 'asc';
        }

        // Update header icon
        const iconClass = sortDirection === 'asc' ? 'fa-sort-asc' : 'fa-sort-desc';
        headers[columnIndex].innerHTML = `${headers[columnIndex].textContent.replace(/<i[^>]*>/g, '').trim()} <i class="fa ${iconClass} ml-1 text-primary"></i>`;

        // Sort data
        filteredData.sort((a, b) => {
            const valueA = a[sortField];
            const valueB = b[sortField];

            // Try to convert values to numbers for comparison
            const numA = parseFloat(valueA);
            const numB = parseFloat(valueB);

            if (!isNaN(numA) && !isNaN(numB)) {
                return sortDirection === 'asc' ? numA - numB : numB - numA;
            }

            // If cannot convert to numbers, compare as strings
            return sortDirection === 'asc'
                ? valueA.toString().localeCompare(valueB.toString())
                : valueB.toString().localeCompare(valueA.toString());
        });

        // Reset pagination and re-render table
        currentPage = 1;
        renderTable();
        updatePagination();
    }

    // Download results
    function downloadResults(format) {
        const resultTable = document.getElementById('resultTable');
        if (resultTable.innerHTML.trim()) {
            let content, contentType, fileName;

            switch (format) {
                case 'csv':
                    content = getTableCSV(resultTable);
                    contentType = 'text/csv;charset=utf-8;';
                    fileName = `${translations[currentLang]['es-query-result']}-${Math.floor(Date.now() / 1000)}.csv`;
                    break;
                case 'json':
                    content = getTableJSON(resultTable);
                    contentType = 'application/json;charset=utf-8;';
                    fileName = `${translations[currentLang]['es-query-result']}-${Math.floor(Date.now() / 1000)}.json`;
                    break;
                case 'excel':
                    content = getTableExcel(resultTable);
                    contentType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
                    fileName = `${translations[currentLang]['es-query-result']}-${Math.floor(Date.now() / 1000)}.xlsx`;
                    break;
                default:
                    content = getTableCSV(resultTable);
                    contentType = 'text/csv;charset=utf-8;';
                    fileName = `${translations[currentLang]['es-query-result']}-${Math.floor(Date.now() / 1000)}.csv`;
            }

            const blob = new Blob([content], {type: contentType});
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', fileName);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast(`${translations[currentLang]['downloading']} ${fileName}`);
        }
    }

    // Get table Excel content
    function getTableExcel(table) {
        const wb = XLSX.utils.book_new();
        const wsData = [];

        const headerCells = table.rows[0].cells;
        const headerRow = [];
        for (let i = 0; i < headerCells.length; i++) {
            headerRow.push(headerCells[i].textContent.trim());
        }
        wsData.push(headerRow);

        for (let i = 1; i < table.rows.length; i++) {
            const cells = table.rows[i].cells;
            const dataRow = [];
            for (let j = 0; j < cells.length; j++) {
                // Handle possible span elements
                const span = cells[j].querySelector('span');
                dataRow.push(span ? span.textContent.trim() : cells[j].textContent.trim());
            }
            wsData.push(dataRow);
        }

        const ws = XLSX.utils.aoa_to_sheet(wsData);
        XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
        return XLSX.write(wb, {bookType: 'xlsx', type: 'array'});
    }

    // Get table JSON content
    function getTableJSON(table) {
        const headers = [];
        const rows = [];

        // Get headers
        const headerCells = table.rows[0].cells;
        for (let i = 0; i < headerCells.length; i++) {
            headers.push(headerCells[i].textContent.trim());
        }

        // Get data rows
        for (let i = 1; i < table.rows.length; i++) {
            const row = {};
            const cells = table.rows[i].cells;

            for (let j = 0; j < cells.length; j++) {
                // Handle status labels
                let cellValue = cells[j].textContent.trim();
                if (cells[j].querySelector('span')) {
                    cellValue = cells[j].querySelector('span').textContent.trim();
                }

                row[headers[j]] = cellValue;
            }

            rows.push(row);
        }

        return JSON.stringify(rows, null, 2);
    }

    // Get table CSV content
    function getTableCSV(table) {
        let csv = '';

        // Add headers
        const headerCells = table.rows[0].cells;
        for (let i = 0; i < headerCells.length; i++) {
            let cellText = headerCells[i].textContent.replace(/"/g, '""');
            if (cellText.includes(',') || cellText.includes('\n')) {
                cellText = `"${cellText}"`;
            }
            csv += cellText + (i === headerCells.length - 1 ? '\n' : ',');
        }

        // Add data rows
        for (let i = 1; i < table.rows.length; i++) {
            const cells = table.rows[i].cells;
            for (let j = 0; j < cells.length; j++) {
                // Handle status labels
                let cellValue = cells[j].textContent.trim();
                if (cells[j].querySelector('span')) {
                    cellValue = cells[j].querySelector('span').textContent.trim();
                }

                let cellText = cellValue.replace(/"/g, '""');
                if (cellText.includes(',') || cellText.includes('\n')) {
                    cellText = `"${cellText}"`;
                }
                csv += cellText + (j === cells.length - 1 ? '\n' : ',');
            }
        }

        return csv;
    }

    // Get table text
    function getTableText(table) {
        let text = '';
        const rows = table.rows;
        for (let i = 0; i < rows.length; i++) {
            const cells = rows[i].cells;
            for (let j = 0; j < cells.length; j++) {
                // Handle status labels
                let cellValue = cells[j].textContent.trim();
                if (cells[j].querySelector('span')) {
                    cellValue = cells[j].querySelector('span').textContent.trim();
                }

                text += cellValue + (j === cells.length - 1 ? '\n' : '\t');
            }
        }
        return text;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function () {
        updateLanguage(currentLang);
    });
</script>
</body>

</html>